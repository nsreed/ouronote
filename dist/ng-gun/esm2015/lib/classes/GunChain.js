import { __awaiter, __decorate, __param } from "tslib";
import { Inject, Injectable, Optional, SkipSelf } from '@angular/core';
import * as Gun from 'gun';
import { from, fromEventPattern, of, Subject, throwError, } from 'rxjs';
import { debounceTime, delay, filter, map, mergeAll, mergeMap, retryWhen, scan, shareReplay, take, timeout, } from 'rxjs/operators';
import { tap } from 'rxjs/operators';
import { gunPath, gunChainArray, } from '../functions/gun-utils';
import * as i0 from "@angular/core";
export const GUN_NODE = Symbol('GUN_NODE');
export class GunChain {
    constructor(ngZone, gun) {
        this.ngZone = ngZone;
        this.isNested = false;
        this.certificate$ = new Subject();
        this.certificates = {};
        this.sources = new Map();
        this._auth = null;
        if (!gun) {
            this.gun = new Gun();
        }
        else {
            this.gun = gun;
        }
    }
    get gun() {
        return this._gun;
    }
    set gun(value) {
        var _a;
        this._gun = value;
        const myKey = value._.get;
        const path = gunPath(value);
        const chainArray = gunChainArray(value);
        this.path = path;
        const userPair = this.gun.user().is;
        if (!userPair) {
            // TODO figure out how to handle this case
            console.warn('NO PAIR');
            return;
        }
        const myPub = `~${(_a = this.gun.user().is) === null || _a === void 0 ? void 0 : _a.pub}`;
        const pubs = path.filter((key) => key.startsWith('~'));
        if (pubs.length === 0 || pubs[0] !== myPub) {
            pubs.push(myPub);
        }
        if (pubs.length > 1) {
            this.isNested = true;
            this.recordPub = pubs[0];
            const firstPub = path.findIndex((key) => key.startsWith('~'));
            const pathFromRecord = [...path];
            const recordPath = pathFromRecord.splice(firstPub).reverse();
            pathFromRecord.reverse();
            if (myKey === this.recordPub) {
                console.log('sub root', myKey);
            }
            else {
                const keyInRecord = pathFromRecord[0];
                const record = chainArray[firstPub];
                const recordCerts = record.get('certs');
                const pathCerts = recordCerts.get(keyInRecord);
                const myCert = pathCerts.get(userPair.pub);
                // console.log('  %s', keyInRecord);
                myCert.on((cert) => __awaiter(this, void 0, void 0, function* () {
                    if (cert === null || cert === undefined) {
                        return;
                    }
                    // console.log('cert', cert);
                    // TODO verify cert later, the await causes chained put() calls to fail
                    // const verified = await SEA.verify(
                    //   cert,
                    //   this.recordPub.replace('~', '')
                    // );
                    this.certificate = cert;
                    this.certificate$.next(cert);
                    // console.log(
                    //   'verified cert for %s.%s',
                    //   this.recordPub,
                    //   keyInRecord,
                    //   pathFromRecord.join('.')
                    // );
                }));
                this.record = record;
            }
        }
    }
    from(gun) {
        return new GunChain(this.ngZone, gun);
    }
    get(key) {
        const soul = this.getSoul(key);
        return this.from(this.gun.get(soul));
    }
    put(data, certificate = this.certificate) {
        // FIXME "unverified data" - certified put values must be signed?
        if (this.isNested && !certificate) {
            console.warn('NO CERTIFICATE FOUND FOR FOREIGN RECORD!');
        }
        const result = this.from(this.gun.put(data, null, certificate ? { opt: { cert: certificate } } : undefined));
        // this.once().subscribe((me) => {
        //   console.log('me', me);
        // });
        return result;
    }
    set(data) {
        // TODO get certificate for set()
        return this.from(this.gun.set(data));
    }
    unset(data) {
        if (this.gun.unset) {
            return this.from(this.gun.unset(data));
        }
        else {
            throw new Error('CANNOT FIND Gun.chain.unset!');
        }
    }
    query(query) {
        return this.from(this.gun.get(query));
    }
    load() {
        // return this.from((this.gun as any).load((d: any) => d) as any);
        return fromEventPattern((handler) => {
            const signal = { stopped: false };
            this.gun.load((data) => {
                const converted = data;
                this.ngZone.run(() => {
                    handler(converted);
                });
            });
            return signal;
        }, (handler, signal) => {
            signal.stopped = true;
        }).pipe(take(1));
    }
    open() {
        // return this.from((this.gun as any).load((d: any) => d) as any);
        return fromEventPattern((handler) => {
            const signal = { stopped: false };
            this.gun.open((data) => {
                const converted = data;
                this.ngZone.run(() => {
                    handler(converted);
                });
            });
            return signal;
        }, (handler, signal) => {
            signal.stopped = true;
        }).pipe(debounceTime(25));
    }
    map(options) {
        return this.from(this.gun.map());
    }
    reduce(options) {
        const base = this.from(this.gun.map());
        return base.on({ includeKeys: true }).pipe(scan((acc, val) => {
            if (val[0] === null || undefined === val[0]) {
                delete acc[val[1]];
            }
            else {
                acc[val[1]] = val[0];
            }
            return acc;
        }, {}), map((v) => (options === null || options === void 0 ? void 0 : options.includeNulls) ? v
            : Object.values(v).filter((ov) => ov !== undefined)), debounceTime(100));
    }
    not() {
        return fromEventPattern((handler) => {
            const signal = { stopped: false };
            if (this.gun.not) {
                this.gun.not((key) => {
                    handler(key);
                });
            }
        });
    }
    on(options) {
        return fromEventPattern((handler) => {
            const signal = { stopped: false };
            this.gun.on((data, key, at, ev) => {
                if (signal.stopped) {
                    return ev.off();
                }
                const dispatchHandler = () => {
                    if (options === null || options === void 0 ? void 0 : options.includeKeys) {
                        handler(data, key);
                    }
                    else {
                        handler(data);
                    }
                };
                // FIXME: ngZone.run() causes infinite recursion
                if (options === null || options === void 0 ? void 0 : options.bypassZone) {
                    dispatchHandler();
                }
                else {
                    this.ngZone.run(dispatchHandler);
                }
            }, options);
            return signal;
        }, (handler, signal) => {
            signal.stopped = true;
        });
    }
    once() {
        return fromEventPattern((handler) => {
            const signal = { stopped: false };
            this.gun.once((data, key, at, ev) => {
                if (ev && signal.stopped) {
                    return ev.off();
                }
                this.ngZone.run(() => {
                    handler(data);
                });
            });
            return signal;
        }, (handler, signal) => {
            signal.stopped = true;
        }).pipe(take(1));
    }
    auth() {
        if (!this._auth) {
            this._auth = new GunAuthChain(this.ngZone, 
            //// no fix for this... gun.user.is is static! can't have multiple logins on a single gun instance
            // TODO allow option to create a new gun instance for this auth call
            this.gun.user().recall({ sessionStorage: true }), this);
        }
        return this._auth;
    }
    user(pubKey) {
        return this.from(this.gun.user(pubKey === null || pubKey === void 0 ? void 0 : pubKey.replace(/^~/, '')));
    }
    onEvent(event, node = this.gun) {
        if (!this.sources.has(event)) {
            const source = fromEventPattern((handler) => {
                // console.log('add handler');
                node.on(event, (...args) => {
                    this.ngZone.run(() => {
                        handler(...args);
                    });
                });
            }).pipe(shareReplay(1));
            this.sources.set(event, source);
        }
        return this.sources.get(event);
    }
    getSoul(key) {
        return typeof key === 'object' && Gun.node.is(key)
            ? Gun.node.soul(key)
            : key;
    }
}
GunChain.ɵfac = function GunChain_Factory(t) { return new (t || GunChain)(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(GUN_NODE, 8)); };
GunChain.ɵprov = i0.ɵɵdefineInjectable({ token: GunChain, factory: GunChain.ɵfac });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(GunChain, [{
        type: Injectable
    }], function () { return [{ type: i0.NgZone }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [GUN_NODE]
            }] }]; }, null); })();
/** Represents a top-level authenticated node (user or key pair) */
let GunAuthChain = class GunAuthChain extends GunChain {
    constructor(ngZone, gun, root) {
        super(ngZone, gun);
        this.root = root;
        this.auth$ = this.root.onEvent('auth').pipe(tap((ack) => {
            if (!ack.err) {
                this.is = ack.put;
            }
        }), shareReplay(1));
        this.is = gun.is;
    }
    login(alias, pass) {
        const auth$ = this.root.onEvent('auth').pipe(filter((ack) => !ack.err), filter((ack) => {
            return ack.put.alias === alias;
        }), take(1));
        const login$ = fromEventPattern((handler) => {
            const signal = { stopped: false };
            this.gun.auth(alias, pass, (ack) => {
                this.ngZone.run(() => {
                    handler(ack);
                });
            });
            return signal;
        }, (handler, signal) => {
            signal.stopped = true;
        }).pipe(mergeMap((ack) => (ack.wait ? throwError(new Error(ack)) : of(ack))), retryWhen((errors) => errors.pipe(delay(1000), take(10))));
        const loginOrAuth$ = from([auth$, login$]).pipe(mergeAll(), take(1));
        return loginOrAuth$;
    }
    create(alias, pass) {
        const auth$ = this.root.onEvent('auth').pipe(filter((ack) => {
            return ack.put.alias === alias;
        }), take(1));
        this.gun.create(alias, pass);
        return auth$;
    }
    secret(value) {
        if (this.gun.secret) {
            return this.from(this.gun.secret(value));
        }
        throw new Error('GUN.chain.secret NOT FOUND');
    }
    from(gun) {
        return new GunAuthChain(this.ngZone, gun, this.root);
    }
    recall() {
        this.gun.recall({ sessionStorage: true });
        return this.auth$.pipe(timeout(5000));
    }
    logout() {
        this.gun.leave();
    }
    put(data, certificate = this.certificate) {
        return super.put(data, certificate);
    }
};
GunAuthChain = __decorate([
    __param(1, Optional()),
    __param(1, SkipSelf()),
    __param(2, Optional()), __param(2, SkipSelf())
], GunAuthChain);
export { GunAuthChain };
/** Represents a node nested under a user/pair
 * gun.user() : AuthChain
 * gun.user(pub) : UserChain
 * gun.get('~@alias') : GunChain<{pub: string}>
 */
export class GunCertChain extends GunChain {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3VuQ2hhaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1ndW4vc3JjL2xpYi9jbGFzc2VzL0d1bkNoYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBVSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9FLE9BQU8sS0FBSyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBVTNCLE9BQU8sRUFDTCxJQUFJLEVBQ0osZ0JBQWdCLEVBRWhCLEVBQUUsRUFDRixPQUFPLEVBQ1AsVUFBVSxHQUNYLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUNMLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLEdBQUcsRUFDSCxRQUFRLEVBQ1IsUUFBUSxFQUNSLFNBQVMsRUFDVCxJQUFJLEVBQ0osV0FBVyxFQUVYLElBQUksRUFDSixPQUFPLEdBQ1IsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUNMLE9BQU8sRUFDUCxhQUFhLEdBRWQsTUFBTSx3QkFBd0IsQ0FBQzs7QUFFaEMsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQStCM0MsTUFBTSxPQUFPLFFBQVE7SUFzRm5CLFlBQ1ksTUFBYyxFQUd4QixHQUVjO1FBTEosV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWpGMUIsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUtqQixpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUF5RnJDLGlCQUFZLEdBQWUsRUFBRSxDQUFDO1FBQ3RCLFlBQU8sR0FBRyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUM3QyxVQUFLLEdBQWdELElBQUksQ0FBQztRQVJoRSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1IsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBUyxDQUFDO1NBQzdCO2FBQU07WUFDTCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztTQUNoQjtJQUNILENBQUM7SUFuRkQsSUFBVyxHQUFHO1FBR1osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDRCxJQUFXLEdBQUcsQ0FDWixLQUVjOztRQUVkLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLE1BQU0sS0FBSyxHQUFJLEtBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBRW5DLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFZLENBQUMsQ0FBQztRQUNuQyxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsS0FBWSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFFakIsTUFBTSxRQUFRLEdBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQVUsQ0FBQyxFQUFFLENBQUM7UUFDN0MsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLDBDQUEwQztZQUMxQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hCLE9BQU87U0FDUjtRQUNELE1BQU0sS0FBSyxHQUFHLElBQUksTUFBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBVSxDQUFDLEVBQUUsMENBQUUsR0FBRyxFQUFFLENBQUM7UUFDckQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssRUFBRTtZQUMxQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2xCO1FBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDOUQsTUFBTSxjQUFjLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDN0QsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRXpCLElBQUksS0FBSyxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ2hDO2lCQUFNO2dCQUNMLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEMsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLFNBQVMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUMvQyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDM0Msb0NBQW9DO2dCQUNwQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQU8sSUFBUyxFQUFFLEVBQUU7b0JBQzVCLElBQUksSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO3dCQUN2QyxPQUFPO3FCQUNSO29CQUNELDZCQUE2QjtvQkFDN0IsdUVBQXVFO29CQUN2RSxxQ0FBcUM7b0JBQ3JDLFVBQVU7b0JBQ1Ysb0NBQW9DO29CQUNwQyxLQUFLO29CQUNMLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO29CQUN4QixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDN0IsZUFBZTtvQkFDZiwrQkFBK0I7b0JBQy9CLG9CQUFvQjtvQkFDcEIsaUJBQWlCO29CQUNqQiw2QkFBNkI7b0JBQzdCLEtBQUs7Z0JBQ1AsQ0FBQyxDQUFBLENBQUMsQ0FBQztnQkFFSCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQzthQUN0QjtTQUNGO0lBQ0gsQ0FBQztJQW9CRCxJQUFJLENBQUksR0FBMEI7UUFDaEMsT0FBTyxJQUFJLFFBQVEsQ0FBSSxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQVUsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxHQUFHLENBQ0QsR0FBNEQ7UUFFNUQsTUFBTSxJQUFJLEdBRWMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsR0FBRyxDQUNELElBRUMsRUFDRCxjQUFzQixJQUFJLENBQUMsV0FBVztRQUV0QyxpRUFBaUU7UUFFakUsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2pDLE9BQU8sQ0FBQyxJQUFJLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUMxRDtRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQ3JCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBVyxDQUNuQixJQUFJLEVBQ0osSUFBSSxFQUNKLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUN6RCxDQUNGLENBQUM7UUFDRixrQ0FBa0M7UUFDbEMsMkJBQTJCO1FBQzNCLE1BQU07UUFDTixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsR0FBRyxDQUNELElBU0M7UUFFRCxpQ0FBaUM7UUFDakMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUF1QjtRQUMzQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ3hDO2FBQU07WUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7U0FDakQ7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQW1CO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFZLENBQUMsQ0FBUSxDQUFDO0lBQ3RELENBQUM7SUFFRCxJQUFJO1FBQ0Ysa0VBQWtFO1FBQ2xFLE9BQU8sZ0JBQWdCLENBQ3JCLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDVixNQUFNLE1BQU0sR0FBRyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQztZQUNqQyxJQUFJLENBQUMsR0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO2dCQUNuQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUM7Z0JBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtvQkFDbkIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNyQixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxFQUNELENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLENBQUMsQ0FDRixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBQ0QsSUFBSTtRQUNGLGtFQUFrRTtRQUNsRSxPQUFPLGdCQUFnQixDQUNyQixDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1YsTUFBTSxNQUFNLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLEdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtnQkFDbkMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDO2dCQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7b0JBQ25CLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDckIsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsRUFDRCxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNsQixNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUN4QixDQUFDLENBQ0YsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELEdBQUcsQ0FBQyxPQUFpQztRQUNuQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxNQUFNLENBQUMsT0FBaUM7UUFDdEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFdkMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUN4QyxJQUFJLENBQUMsQ0FBQyxHQUFRLEVBQUUsR0FBUSxFQUFFLEVBQUU7WUFDMUIsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLFNBQVMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzNDLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3BCO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEI7WUFDRCxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFnQixDQUFDLEVBQ3BCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ1IsQ0FBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsWUFBWSxFQUNuQixDQUFDLENBQUMsQ0FBQztZQUNILENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQyxDQUN0RCxFQUNELFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FDbEIsQ0FBQztJQUNKLENBQUM7SUFFRCxHQUFHO1FBQ0QsT0FBTyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ2xDLE1BQU0sTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO1lBQ2xDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBaUIsRUFBRSxFQUFFO29CQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2YsQ0FBQyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEVBQUUsQ0FDQSxPQUFpQztRQUVqQyxPQUFPLGdCQUFnQixDQUNyQixDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1YsTUFBTSxNQUFNLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQ1QsQ0FDRSxJQUFtRCxFQUNuRCxHQUFHLEVBQ0gsRUFBUSxFQUNSLEVBQVEsRUFDUixFQUFFO2dCQUNGLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDbEIsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUM7aUJBQ2pCO2dCQUNELE1BQU0sZUFBZSxHQUFHLEdBQUcsRUFBRTtvQkFDM0IsSUFBSSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsV0FBVyxFQUFFO3dCQUN4QixPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO3FCQUNwQjt5QkFBTTt3QkFDTCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQ2Y7Z0JBQ0gsQ0FBQyxDQUFDO2dCQUNGLGdEQUFnRDtnQkFDaEQsSUFBSSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsVUFBVSxFQUFFO29CQUN2QixlQUFlLEVBQUUsQ0FBQztpQkFDbkI7cUJBQU07b0JBQ0wsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQ2xDO1lBQ0gsQ0FBQyxFQUNELE9BQWMsQ0FDZixDQUFDO1lBQ0YsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxFQUNELENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELElBQUk7UUFDRixPQUFPLGdCQUFnQixDQUNyQixDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1YsTUFBTSxNQUFNLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQ1gsQ0FDRSxJQU1hLEVBQ2IsR0FBRyxFQUNILEVBQVEsRUFDUixFQUFRLEVBQ1IsRUFBRTtnQkFDRixJQUFJLEVBQUUsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFO29CQUN4QixPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztpQkFDakI7Z0JBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO29CQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUNGLENBQUM7WUFDRixPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLEVBQ0QsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDeEIsQ0FBQyxDQUNGLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxJQUFJO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksWUFBWSxDQUMzQixJQUFJLENBQUMsTUFBTTtZQUNYLGtHQUFrRztZQUNsRyxvRUFBb0U7WUFDcEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLENBQVEsRUFDdkQsSUFBVyxDQUNaLENBQUM7U0FDSDtRQUNELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBSSxDQUFDLE1BQWU7UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFhLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHO1FBQ3BDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM1QixNQUFNLE1BQU0sR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUMxQyw4QkFBOEI7Z0JBQzdCLElBQVksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxJQUFTLEVBQUUsRUFBRTtvQkFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO3dCQUNuQixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztvQkFDbkIsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ2pDO1FBQ0QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQW9CLENBQUM7SUFDcEQsQ0FBQztJQUVTLE9BQU8sQ0FBQyxHQUFRO1FBQ3hCLE9BQU8sT0FBTyxHQUFHLEtBQUssUUFBUSxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQztZQUNoRCxDQUFDLENBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFTO1lBQzdCLENBQUMsQ0FBQyxHQUFHLENBQUM7SUFDVixDQUFDOztnRUEvVlUsUUFBUSxzQ0F5RlQsUUFBUTtnREF6RlAsUUFBUSxXQUFSLFFBQVE7dUZBQVIsUUFBUTtjQURwQixVQUFVOztzQkF5Rk4sUUFBUTs7c0JBQ1IsTUFBTTt1QkFBQyxRQUFROztBQXlRcEIsbUVBQW1FO0FBQ25FLElBQWEsWUFBWSxHQUF6QixNQUFhLFlBSVgsU0FBUSxRQUF1QztJQVcvQyxZQUNFLE1BQWMsRUFHZCxHQUV1QixFQUNRLElBQWM7UUFFN0MsS0FBSyxDQUFDLE1BQU0sRUFBRSxHQUFVLENBQUMsQ0FBQztRQUZLLFNBQUksR0FBSixJQUFJLENBQVU7UUFoQi9DLFVBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQ3BDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO2FBQ25CO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUNmLENBQUM7UUFZQSxJQUFJLENBQUMsRUFBRSxHQUFJLEdBQVcsQ0FBQyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFhLEVBQUUsSUFBWTtRQUMvQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQzFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQ3pCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2IsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUM7UUFDakMsQ0FBQyxDQUFDLEVBQ0YsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNSLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBRyxnQkFBZ0IsQ0FDN0IsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNWLE1BQU0sTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtnQkFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO29CQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2YsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUNILE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsRUFDRCxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNsQixNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUN4QixDQUFDLENBQ0YsQ0FBQyxJQUFJLENBQ0osUUFBUSxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUN6RSxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQzFELENBQUM7UUFDRixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckUsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFhLEVBQUUsSUFBWTtRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQzFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2IsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUM7UUFDakMsQ0FBQyxDQUFDLEVBQ0YsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNSLENBQUM7UUFDRixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0IsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQVU7UUFDZixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQzFDO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxJQUFJLENBQUksR0FBMEI7UUFDaEMsT0FBTyxJQUFJLFlBQVksQ0FBSSxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFDRCxHQUFHLENBQ0QsSUFFQyxFQUNELGNBQXNCLElBQUksQ0FBQyxXQUFXO1FBRXRDLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGLENBQUE7QUFoR1ksWUFBWTtJQWlCcEIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtJQUNWLFdBQUEsUUFBUSxFQUFFLENBQUE7SUFJVixXQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsV0FBQSxRQUFRLEVBQUUsQ0FBQTtHQXRCZCxZQUFZLENBZ0d4QjtTQWhHWSxZQUFZO0FBa0d6Qjs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLFlBQWEsU0FBUSxRQUFRO0NBQUciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE5nWm9uZSwgT3B0aW9uYWwsIFNraXBTZWxmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBHdW4gZnJvbSAnZ3VuJztcbmltcG9ydCB7IElHdW5DaGFpblJlZmVyZW5jZSB9IGZyb20gJ2d1bi90eXBlcy9jaGFpbic7XG5pbXBvcnQgeyBJR3VuU3RhdGljU0VBIH0gZnJvbSAnZ3VuL3R5cGVzL3N0YXRpYy9zZWEnO1xuaW1wb3J0IHtcbiAgQWx3YXlzRGlzYWxsb3dlZFR5cGUsXG4gIEFycmF5QXNSZWNvcmQsXG4gIEFycmF5T2YsXG4gIERpc2FsbG93QXJyYXksXG4gIERpc2FsbG93UHJpbWl0aXZlcyxcbn0gZnJvbSAnZ3VuL3R5cGVzL3R5cGVzJztcbmltcG9ydCB7XG4gIGZyb20sXG4gIGZyb21FdmVudFBhdHRlcm4sXG4gIE9ic2VydmFibGUsXG4gIG9mLFxuICBTdWJqZWN0LFxuICB0aHJvd0Vycm9yLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRlYm91bmNlVGltZSxcbiAgZGVsYXksXG4gIGZpbHRlcixcbiAgbWFwLFxuICBtZXJnZUFsbCxcbiAgbWVyZ2VNYXAsXG4gIHJldHJ5V2hlbixcbiAgc2NhbixcbiAgc2hhcmVSZXBsYXksXG4gIHN3aXRjaE1hcCxcbiAgdGFrZSxcbiAgdGltZW91dCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTGV4aWNhbFF1ZXJ5IH0gZnJvbSAnLi9MZXhpY2FsUXVlcnknO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSUd1blBlZXIgfSBmcm9tICcuL0lHdW5QZWVyJztcbmltcG9ydCB7IFNFQSB9IGZyb20gJ2d1bic7XG5pbXBvcnQgeyBJQ2VydFN0b3JlIH0gZnJvbSAnLi9JQ2VydFN0b3JlJztcbmltcG9ydCB7XG4gIGd1blBhdGgsXG4gIGd1bkNoYWluQXJyYXksXG4gIHBhcnNlQ2VydGlmaWNhdGUsXG59IGZyb20gJy4uL2Z1bmN0aW9ucy9ndW4tdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgR1VOX05PREUgPSBTeW1ib2woJ0dVTl9OT0RFJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3VuQ2hhaW5DYWxsYmFja09wdGlvbnMge1xuICBpbmNsdWRlS2V5cz86IGJvb2xlYW47XG4gIGluY2x1ZGVOdWxscz86IGJvb2xlYW47XG4gIGNoYW5nZXM/OiBib29sZWFuO1xuICBieXBhc3Nab25lPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHdW5DaGFpbkZ1bmN0aW9ucyB7XG4gIHNlY3JldDogKHZhbHVlOiBhbnkpID0+IElHdW5DaGFpblJlZmVyZW5jZTtcbiAgZ3JhbnQ6ICh2YWx1ZTogYW55KSA9PiBJR3VuQ2hhaW5SZWZlcmVuY2U7XG59XG5cbmludGVyZmFjZSBJR3VuUGVlcnMge1xuICBba2V5OiBzdHJpbmddOiBJR3VuUGVlcjtcbn1cblxuaW50ZXJmYWNlIElHdW5Sb290T3B0IHtcbiAgcGVlcnM6IElHdW5QZWVycztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHdW5DaGFpbk1ldGEge1xuICBfOiB7XG4gICAgcm9vdDoge1xuICAgICAgb3B0OiBJR3VuUm9vdE9wdDtcbiAgICB9O1xuICB9ICYgYW55O1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgR3VuQ2hhaW48XG4gIERhdGFUeXBlID0gUmVjb3JkPHN0cmluZywgYW55PixcbiAgUmVmZXJlbmNlS2V5ID0gYW55LFxuICBJc1RvcCBleHRlbmRzICdwcmVfcm9vdCcgfCAncm9vdCcgfCBmYWxzZSA9IGZhbHNlXG4+IHtcbiAgcGF0aCE6IHN0cmluZ1tdO1xuICBpc05lc3RlZCA9IGZhbHNlO1xuICByZWNvcmRQdWIhOiBhbnk7XG4gIHJlY29yZD86IGFueTtcbiAgY2VydGlmaWNhdGUhOiBzdHJpbmc7XG5cbiAgY2VydGlmaWNhdGUkID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuXG4gIHByaXZhdGUgX2d1biE6IElHdW5DaGFpblJlZmVyZW5jZTxEYXRhVHlwZSwgUmVmZXJlbmNlS2V5LCBJc1RvcD4gJlxuICAgIEd1bkNoYWluRnVuY3Rpb25zICZcbiAgICBHdW5DaGFpbk1ldGE7XG4gIHB1YmxpYyBnZXQgZ3VuKCk6IElHdW5DaGFpblJlZmVyZW5jZTxEYXRhVHlwZSwgUmVmZXJlbmNlS2V5LCBJc1RvcD4gJlxuICAgIEd1bkNoYWluRnVuY3Rpb25zICZcbiAgICBHdW5DaGFpbk1ldGEge1xuICAgIHJldHVybiB0aGlzLl9ndW47XG4gIH1cbiAgcHVibGljIHNldCBndW4oXG4gICAgdmFsdWU6IElHdW5DaGFpblJlZmVyZW5jZTxEYXRhVHlwZSwgUmVmZXJlbmNlS2V5LCBJc1RvcD4gJlxuICAgICAgR3VuQ2hhaW5GdW5jdGlvbnMgJlxuICAgICAgR3VuQ2hhaW5NZXRhXG4gICkge1xuICAgIHRoaXMuX2d1biA9IHZhbHVlO1xuICAgIGNvbnN0IG15S2V5ID0gKHZhbHVlIGFzIGFueSkuXy5nZXQ7XG5cbiAgICBjb25zdCBwYXRoID0gZ3VuUGF0aCh2YWx1ZSBhcyBhbnkpO1xuICAgIGNvbnN0IGNoYWluQXJyYXkgPSBndW5DaGFpbkFycmF5KHZhbHVlIGFzIGFueSk7XG4gICAgdGhpcy5wYXRoID0gcGF0aDtcblxuICAgIGNvbnN0IHVzZXJQYWlyID0gKHRoaXMuZ3VuLnVzZXIoKSBhcyBhbnkpLmlzO1xuICAgIGlmICghdXNlclBhaXIpIHtcbiAgICAgIC8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gaGFuZGxlIHRoaXMgY2FzZVxuICAgICAgY29uc29sZS53YXJuKCdOTyBQQUlSJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG15UHViID0gYH4keyh0aGlzLmd1bi51c2VyKCkgYXMgYW55KS5pcz8ucHVifWA7XG4gICAgY29uc3QgcHVicyA9IHBhdGguZmlsdGVyKChrZXkpID0+IGtleS5zdGFydHNXaXRoKCd+JykpO1xuICAgIGlmIChwdWJzLmxlbmd0aCA9PT0gMCB8fCBwdWJzWzBdICE9PSBteVB1Yikge1xuICAgICAgcHVicy5wdXNoKG15UHViKTtcbiAgICB9XG4gICAgaWYgKHB1YnMubGVuZ3RoID4gMSkge1xuICAgICAgdGhpcy5pc05lc3RlZCA9IHRydWU7XG4gICAgICB0aGlzLnJlY29yZFB1YiA9IHB1YnNbMF07XG4gICAgICBjb25zdCBmaXJzdFB1YiA9IHBhdGguZmluZEluZGV4KChrZXkpID0+IGtleS5zdGFydHNXaXRoKCd+JykpO1xuICAgICAgY29uc3QgcGF0aEZyb21SZWNvcmQgPSBbLi4ucGF0aF07XG4gICAgICBjb25zdCByZWNvcmRQYXRoID0gcGF0aEZyb21SZWNvcmQuc3BsaWNlKGZpcnN0UHViKS5yZXZlcnNlKCk7XG4gICAgICBwYXRoRnJvbVJlY29yZC5yZXZlcnNlKCk7XG5cbiAgICAgIGlmIChteUtleSA9PT0gdGhpcy5yZWNvcmRQdWIpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ3N1YiByb290JywgbXlLZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qga2V5SW5SZWNvcmQgPSBwYXRoRnJvbVJlY29yZFswXTtcbiAgICAgICAgY29uc3QgcmVjb3JkID0gY2hhaW5BcnJheVtmaXJzdFB1Yl07XG4gICAgICAgIGNvbnN0IHJlY29yZENlcnRzID0gcmVjb3JkLmdldCgnY2VydHMnKTtcbiAgICAgICAgY29uc3QgcGF0aENlcnRzID0gcmVjb3JkQ2VydHMuZ2V0KGtleUluUmVjb3JkKTtcbiAgICAgICAgY29uc3QgbXlDZXJ0ID0gcGF0aENlcnRzLmdldCh1c2VyUGFpci5wdWIpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnICAlcycsIGtleUluUmVjb3JkKTtcbiAgICAgICAgbXlDZXJ0Lm9uKGFzeW5jIChjZXJ0OiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAoY2VydCA9PT0gbnVsbCB8fCBjZXJ0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ2NlcnQnLCBjZXJ0KTtcbiAgICAgICAgICAvLyBUT0RPIHZlcmlmeSBjZXJ0IGxhdGVyLCB0aGUgYXdhaXQgY2F1c2VzIGNoYWluZWQgcHV0KCkgY2FsbHMgdG8gZmFpbFxuICAgICAgICAgIC8vIGNvbnN0IHZlcmlmaWVkID0gYXdhaXQgU0VBLnZlcmlmeShcbiAgICAgICAgICAvLyAgIGNlcnQsXG4gICAgICAgICAgLy8gICB0aGlzLnJlY29yZFB1Yi5yZXBsYWNlKCd+JywgJycpXG4gICAgICAgICAgLy8gKTtcbiAgICAgICAgICB0aGlzLmNlcnRpZmljYXRlID0gY2VydDtcbiAgICAgICAgICB0aGlzLmNlcnRpZmljYXRlJC5uZXh0KGNlcnQpO1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFxuICAgICAgICAgIC8vICAgJ3ZlcmlmaWVkIGNlcnQgZm9yICVzLiVzJyxcbiAgICAgICAgICAvLyAgIHRoaXMucmVjb3JkUHViLFxuICAgICAgICAgIC8vICAga2V5SW5SZWNvcmQsXG4gICAgICAgICAgLy8gICBwYXRoRnJvbVJlY29yZC5qb2luKCcuJylcbiAgICAgICAgICAvLyApO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnJlY29yZCA9IHJlY29yZDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgbmdab25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KEdVTl9OT0RFKVxuICAgIGd1bjogSUd1bkNoYWluUmVmZXJlbmNlPERhdGFUeXBlLCBSZWZlcmVuY2VLZXksIElzVG9wPiAmXG4gICAgICBHdW5DaGFpbkZ1bmN0aW9ucyAmXG4gICAgICBHdW5DaGFpbk1ldGFcbiAgKSB7XG4gICAgaWYgKCFndW4pIHtcbiAgICAgIHRoaXMuZ3VuID0gbmV3IEd1bigpIGFzIGFueTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5ndW4gPSBndW47XG4gICAgfVxuICB9XG4gIGNlcnRpZmljYXRlczogSUNlcnRTdG9yZSA9IHt9O1xuICBwcml2YXRlIHNvdXJjZXMgPSBuZXcgTWFwPHN0cmluZywgT2JzZXJ2YWJsZTxhbnk+PigpO1xuICBwcml2YXRlIF9hdXRoOiBHdW5BdXRoQ2hhaW48RGF0YVR5cGUsIFJlZmVyZW5jZUtleT4gfCBudWxsID0gbnVsbDtcblxuICBmcm9tPFQ+KGd1bjogSUd1bkNoYWluUmVmZXJlbmNlPFQ+KSB7XG4gICAgcmV0dXJuIG5ldyBHdW5DaGFpbjxUPih0aGlzLm5nWm9uZSwgZ3VuIGFzIGFueSk7XG4gIH1cblxuICBnZXQ8SyBleHRlbmRzIGtleW9mIERhdGFUeXBlPihcbiAgICBrZXk6IEFycmF5T2Y8RGF0YVR5cGU+IGV4dGVuZHMgbmV2ZXIgPyBLIDogQXJyYXlPZjxEYXRhVHlwZT5cbiAgKSB7XG4gICAgY29uc3Qgc291bDogQXJyYXlPZjxEYXRhVHlwZT4gZXh0ZW5kcyBuZXZlclxuICAgICAgPyBLXG4gICAgICA6IEFycmF5T2Y8RGF0YVR5cGU+ID0gdGhpcy5nZXRTb3VsKGtleSk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbSh0aGlzLmd1bi5nZXQoc291bCkpO1xuICB9XG5cbiAgcHV0KFxuICAgIGRhdGE6IFBhcnRpYWw8XG4gICAgICBBbHdheXNEaXNhbGxvd2VkVHlwZTxEaXNhbGxvd1ByaW1pdGl2ZXM8SXNUb3AsIERpc2FsbG93QXJyYXk8RGF0YVR5cGU+Pj5cbiAgICA+LFxuICAgIGNlcnRpZmljYXRlOiBzdHJpbmcgPSB0aGlzLmNlcnRpZmljYXRlXG4gICkge1xuICAgIC8vIEZJWE1FIFwidW52ZXJpZmllZCBkYXRhXCIgLSBjZXJ0aWZpZWQgcHV0IHZhbHVlcyBtdXN0IGJlIHNpZ25lZD9cblxuICAgIGlmICh0aGlzLmlzTmVzdGVkICYmICFjZXJ0aWZpY2F0ZSkge1xuICAgICAgY29uc29sZS53YXJuKCdOTyBDRVJUSUZJQ0FURSBGT1VORCBGT1IgRk9SRUlHTiBSRUNPUkQhJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZnJvbShcbiAgICAgICh0aGlzLmd1bi5wdXQgYXMgYW55KShcbiAgICAgICAgZGF0YSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgY2VydGlmaWNhdGUgPyB7IG9wdDogeyBjZXJ0OiBjZXJ0aWZpY2F0ZSB9IH0gOiB1bmRlZmluZWRcbiAgICAgIClcbiAgICApO1xuICAgIC8vIHRoaXMub25jZSgpLnN1YnNjcmliZSgobWUpID0+IHtcbiAgICAvLyAgIGNvbnNvbGUubG9nKCdtZScsIG1lKTtcbiAgICAvLyB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc2V0KFxuICAgIGRhdGE6IEFsd2F5c0Rpc2FsbG93ZWRUeXBlPFxuICAgICAgRGF0YVR5cGUgZXh0ZW5kcyBBcnJheTxpbmZlciBVPlxuICAgICAgICA/IFUgZXh0ZW5kcyB7XG4gICAgICAgICAgICBba2V5OiBzdHJpbmddOiBhbnk7XG4gICAgICAgICAgICBba2V5OiBudW1iZXJdOiBhbnk7XG4gICAgICAgICAgfVxuICAgICAgICAgID8gQXJyYXlPZjxEYXRhVHlwZT5cbiAgICAgICAgICA6IG5ldmVyXG4gICAgICAgIDogbmV2ZXJcbiAgICA+XG4gICkge1xuICAgIC8vIFRPRE8gZ2V0IGNlcnRpZmljYXRlIGZvciBzZXQoKVxuICAgIHJldHVybiB0aGlzLmZyb20odGhpcy5ndW4uc2V0KGRhdGEpKTtcbiAgfVxuXG4gIHVuc2V0KGRhdGE6IEFycmF5T2Y8RGF0YVR5cGU+KSB7XG4gICAgaWYgKHRoaXMuZ3VuLnVuc2V0KSB7XG4gICAgICByZXR1cm4gdGhpcy5mcm9tKHRoaXMuZ3VuLnVuc2V0KGRhdGEpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDQU5OT1QgRklORCBHdW4uY2hhaW4udW5zZXQhJyk7XG4gICAgfVxuICB9XG5cbiAgcXVlcnkocXVlcnk6IExleGljYWxRdWVyeSk6IEd1bkNoYWluPERhdGFUeXBlLCBSZWZlcmVuY2VLZXksIElzVG9wPiB7XG4gICAgcmV0dXJuIHRoaXMuZnJvbSh0aGlzLmd1bi5nZXQocXVlcnkgYXMgYW55KSkgYXMgYW55O1xuICB9XG5cbiAgbG9hZCgpIHtcbiAgICAvLyByZXR1cm4gdGhpcy5mcm9tKCh0aGlzLmd1biBhcyBhbnkpLmxvYWQoKGQ6IGFueSkgPT4gZCkgYXMgYW55KTtcbiAgICByZXR1cm4gZnJvbUV2ZW50UGF0dGVybihcbiAgICAgIChoYW5kbGVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHNpZ25hbCA9IHsgc3RvcHBlZDogZmFsc2UgfTtcbiAgICAgICAgKHRoaXMuZ3VuIGFzIGFueSkubG9hZCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3QgY29udmVydGVkID0gZGF0YTtcbiAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgaGFuZGxlcihjb252ZXJ0ZWQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHNpZ25hbDtcbiAgICAgIH0sXG4gICAgICAoaGFuZGxlciwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHNpZ25hbC5zdG9wcGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICApLnBpcGUodGFrZSgxKSk7XG4gIH1cbiAgb3BlbigpIHtcbiAgICAvLyByZXR1cm4gdGhpcy5mcm9tKCh0aGlzLmd1biBhcyBhbnkpLmxvYWQoKGQ6IGFueSkgPT4gZCkgYXMgYW55KTtcbiAgICByZXR1cm4gZnJvbUV2ZW50UGF0dGVybihcbiAgICAgIChoYW5kbGVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHNpZ25hbCA9IHsgc3RvcHBlZDogZmFsc2UgfTtcbiAgICAgICAgKHRoaXMuZ3VuIGFzIGFueSkub3BlbigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3QgY29udmVydGVkID0gZGF0YTtcbiAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgaGFuZGxlcihjb252ZXJ0ZWQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHNpZ25hbDtcbiAgICAgIH0sXG4gICAgICAoaGFuZGxlciwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHNpZ25hbC5zdG9wcGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICApLnBpcGUoZGVib3VuY2VUaW1lKDI1KSk7XG4gIH1cblxuICBtYXAob3B0aW9ucz86IEd1bkNoYWluQ2FsbGJhY2tPcHRpb25zKSB7XG4gICAgcmV0dXJuIHRoaXMuZnJvbSh0aGlzLmd1bi5tYXAoKSk7XG4gIH1cblxuICByZWR1Y2Uob3B0aW9ucz86IEd1bkNoYWluQ2FsbGJhY2tPcHRpb25zKSB7XG4gICAgY29uc3QgYmFzZSA9IHRoaXMuZnJvbSh0aGlzLmd1bi5tYXAoKSk7XG5cbiAgICByZXR1cm4gYmFzZS5vbih7IGluY2x1ZGVLZXlzOiB0cnVlIH0pLnBpcGUoXG4gICAgICBzY2FuKChhY2M6IGFueSwgdmFsOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKHZhbFswXSA9PT0gbnVsbCB8fCB1bmRlZmluZWQgPT09IHZhbFswXSkge1xuICAgICAgICAgIGRlbGV0ZSBhY2NbdmFsWzFdXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhY2NbdmFsWzFdXSA9IHZhbFswXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwge30gYXMgRGF0YVR5cGVbXSksXG4gICAgICBtYXAoKHYpID0+XG4gICAgICAgIG9wdGlvbnM/LmluY2x1ZGVOdWxsc1xuICAgICAgICAgID8gdlxuICAgICAgICAgIDogT2JqZWN0LnZhbHVlcyh2KS5maWx0ZXIoKG92KSA9PiBvdiAhPT0gdW5kZWZpbmVkKVxuICAgICAgKSxcbiAgICAgIGRlYm91bmNlVGltZSgxMDApXG4gICAgKTtcbiAgfVxuXG4gIG5vdCgpIHtcbiAgICByZXR1cm4gZnJvbUV2ZW50UGF0dGVybigoaGFuZGxlcikgPT4ge1xuICAgICAgY29uc3Qgc2lnbmFsID0geyBzdG9wcGVkOiBmYWxzZSB9O1xuICAgICAgaWYgKHRoaXMuZ3VuLm5vdCkge1xuICAgICAgICB0aGlzLmd1bi5ub3QoKGtleTogUmVmZXJlbmNlS2V5KSA9PiB7XG4gICAgICAgICAgaGFuZGxlcihrZXkpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIG9uKFxuICAgIG9wdGlvbnM/OiBHdW5DaGFpbkNhbGxiYWNrT3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPEFsd2F5c0Rpc2FsbG93ZWRUeXBlPEFycmF5QXNSZWNvcmQ8RGF0YVR5cGU+Pj4ge1xuICAgIHJldHVybiBmcm9tRXZlbnRQYXR0ZXJuKFxuICAgICAgKGhhbmRsZXIpID0+IHtcbiAgICAgICAgY29uc3Qgc2lnbmFsID0geyBzdG9wcGVkOiBmYWxzZSB9O1xuICAgICAgICB0aGlzLmd1bi5vbihcbiAgICAgICAgICAoXG4gICAgICAgICAgICBkYXRhOiBBbHdheXNEaXNhbGxvd2VkVHlwZTxBcnJheUFzUmVjb3JkPERhdGFUeXBlPj4sXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICBhdD86IGFueSxcbiAgICAgICAgICAgIGV2PzogYW55XG4gICAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2lnbmFsLnN0b3BwZWQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV2Lm9mZigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZGlzcGF0Y2hIYW5kbGVyID0gKCkgPT4ge1xuICAgICAgICAgICAgICBpZiAob3B0aW9ucz8uaW5jbHVkZUtleXMpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVyKGRhdGEsIGtleSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlcihkYXRhKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIEZJWE1FOiBuZ1pvbmUucnVuKCkgY2F1c2VzIGluZmluaXRlIHJlY3Vyc2lvblxuICAgICAgICAgICAgaWYgKG9wdGlvbnM/LmJ5cGFzc1pvbmUpIHtcbiAgICAgICAgICAgICAgZGlzcGF0Y2hIYW5kbGVyKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oZGlzcGF0Y2hIYW5kbGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIG9wdGlvbnMgYXMgYW55XG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBzaWduYWw7XG4gICAgICB9LFxuICAgICAgKGhhbmRsZXIsIHNpZ25hbCkgPT4ge1xuICAgICAgICBzaWduYWwuc3RvcHBlZCA9IHRydWU7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIG9uY2UoKSB7XG4gICAgcmV0dXJuIGZyb21FdmVudFBhdHRlcm4oXG4gICAgICAoaGFuZGxlcikgPT4ge1xuICAgICAgICBjb25zdCBzaWduYWwgPSB7IHN0b3BwZWQ6IGZhbHNlIH07XG4gICAgICAgIHRoaXMuZ3VuLm9uY2UoXG4gICAgICAgICAgKFxuICAgICAgICAgICAgZGF0YTpcbiAgICAgICAgICAgICAgfCBBbHdheXNEaXNhbGxvd2VkVHlwZTxBcnJheUFzUmVjb3JkPERhdGFUeXBlPj5cbiAgICAgICAgICAgICAgfCBEaXNhbGxvd1ByaW1pdGl2ZXM8XG4gICAgICAgICAgICAgICAgICBJc1RvcCxcbiAgICAgICAgICAgICAgICAgIEFsd2F5c0Rpc2FsbG93ZWRUeXBlPEFycmF5QXNSZWNvcmQ8RGF0YVR5cGU+PlxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgfCB1bmRlZmluZWQsXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICBhdD86IGFueSxcbiAgICAgICAgICAgIGV2PzogYW55XG4gICAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXYgJiYgc2lnbmFsLnN0b3BwZWQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGV2Lm9mZigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgaGFuZGxlcihkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHNpZ25hbDtcbiAgICAgIH0sXG4gICAgICAoaGFuZGxlciwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHNpZ25hbC5zdG9wcGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICApLnBpcGUodGFrZSgxKSk7XG4gIH1cblxuICBhdXRoKCkge1xuICAgIGlmICghdGhpcy5fYXV0aCkge1xuICAgICAgdGhpcy5fYXV0aCA9IG5ldyBHdW5BdXRoQ2hhaW48RGF0YVR5cGUsIFJlZmVyZW5jZUtleT4oXG4gICAgICAgIHRoaXMubmdab25lLFxuICAgICAgICAvLy8vIG5vIGZpeCBmb3IgdGhpcy4uLiBndW4udXNlci5pcyBpcyBzdGF0aWMhIGNhbid0IGhhdmUgbXVsdGlwbGUgbG9naW5zIG9uIGEgc2luZ2xlIGd1biBpbnN0YW5jZVxuICAgICAgICAvLyBUT0RPIGFsbG93IG9wdGlvbiB0byBjcmVhdGUgYSBuZXcgZ3VuIGluc3RhbmNlIGZvciB0aGlzIGF1dGggY2FsbFxuICAgICAgICB0aGlzLmd1bi51c2VyKCkucmVjYWxsKHsgc2Vzc2lvblN0b3JhZ2U6IHRydWUgfSkgYXMgYW55LFxuICAgICAgICB0aGlzIGFzIGFueVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2F1dGg7XG4gIH1cblxuICB1c2VyKHB1YktleT86IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmZyb20odGhpcy5ndW4udXNlcihwdWJLZXk/LnJlcGxhY2UoL15+LywgJycpKSk7XG4gIH1cblxuICBvbkV2ZW50KGV2ZW50OiBzdHJpbmcsIG5vZGUgPSB0aGlzLmd1bik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKCF0aGlzLnNvdXJjZXMuaGFzKGV2ZW50KSkge1xuICAgICAgY29uc3Qgc291cmNlID0gZnJvbUV2ZW50UGF0dGVybigoaGFuZGxlcikgPT4ge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnYWRkIGhhbmRsZXInKTtcbiAgICAgICAgKG5vZGUgYXMgYW55KS5vbihldmVudCwgKC4uLmFyZ3M6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICBoYW5kbGVyKC4uLmFyZ3MpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICAgICAgdGhpcy5zb3VyY2VzLnNldChldmVudCwgc291cmNlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc291cmNlcy5nZXQoZXZlbnQpIGFzIE9ic2VydmFibGU8YW55PjtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRTb3VsKGtleTogYW55KSB7XG4gICAgcmV0dXJuIHR5cGVvZiBrZXkgPT09ICdvYmplY3QnICYmIEd1bi5ub2RlLmlzKGtleSlcbiAgICAgID8gKEd1bi5ub2RlLnNvdWwoa2V5KSBhcyBhbnkpXG4gICAgICA6IGtleTtcbiAgfVxufVxuXG4vKiogUmVwcmVzZW50cyBhIHRvcC1sZXZlbCBhdXRoZW50aWNhdGVkIG5vZGUgKHVzZXIgb3Iga2V5IHBhaXIpICovXG5leHBvcnQgY2xhc3MgR3VuQXV0aENoYWluPFxuICBEYXRhVHlwZSA9IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gIFJlZmVyZW5jZUtleSA9IGFueSxcbiAgSXNUb3AgPSBmYWxzZVxuPiBleHRlbmRzIEd1bkNoYWluPERhdGFUeXBlLCBSZWZlcmVuY2VLZXksIGZhbHNlPiB7XG4gIGlzOiBhbnk7XG4gIGF1dGgkID0gdGhpcy5yb290Lm9uRXZlbnQoJ2F1dGgnKS5waXBlKFxuICAgIHRhcCgoYWNrKSA9PiB7XG4gICAgICBpZiAoIWFjay5lcnIpIHtcbiAgICAgICAgdGhpcy5pcyA9IGFjay5wdXQ7XG4gICAgICB9XG4gICAgfSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBuZ1pvbmU6IE5nWm9uZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBTa2lwU2VsZigpXG4gICAgZ3VuOiBJR3VuQ2hhaW5SZWZlcmVuY2U8RGF0YVR5cGUsIFJlZmVyZW5jZUtleSwgZmFsc2U+ICZcbiAgICAgIFBhcnRpYWw8R3VuQ2hhaW5GdW5jdGlvbnM+ICZcbiAgICAgIFBhcnRpYWw8R3VuQ2hhaW5NZXRhPixcbiAgICBAT3B0aW9uYWwoKSBAU2tpcFNlbGYoKSBwdWJsaWMgcm9vdDogR3VuQ2hhaW5cbiAgKSB7XG4gICAgc3VwZXIobmdab25lLCBndW4gYXMgYW55KTtcbiAgICB0aGlzLmlzID0gKGd1biBhcyBhbnkpLmlzO1xuICB9XG5cbiAgbG9naW4oYWxpYXM6IHN0cmluZywgcGFzczogc3RyaW5nKSB7XG4gICAgY29uc3QgYXV0aCQgPSB0aGlzLnJvb3Qub25FdmVudCgnYXV0aCcpLnBpcGUoXG4gICAgICBmaWx0ZXIoKGFjaykgPT4gIWFjay5lcnIpLFxuICAgICAgZmlsdGVyKChhY2spID0+IHtcbiAgICAgICAgcmV0dXJuIGFjay5wdXQuYWxpYXMgPT09IGFsaWFzO1xuICAgICAgfSksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcblxuICAgIGNvbnN0IGxvZ2luJCA9IGZyb21FdmVudFBhdHRlcm4oXG4gICAgICAoaGFuZGxlcikgPT4ge1xuICAgICAgICBjb25zdCBzaWduYWwgPSB7IHN0b3BwZWQ6IGZhbHNlIH07XG4gICAgICAgIHRoaXMuZ3VuLmF1dGgoYWxpYXMsIHBhc3MsIChhY2s6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICBoYW5kbGVyKGFjayk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gc2lnbmFsO1xuICAgICAgfSxcbiAgICAgIChoYW5kbGVyLCBzaWduYWwpID0+IHtcbiAgICAgICAgc2lnbmFsLnN0b3BwZWQgPSB0cnVlO1xuICAgICAgfVxuICAgICkucGlwZShcbiAgICAgIG1lcmdlTWFwKChhY2s6IGFueSkgPT4gKGFjay53YWl0ID8gdGhyb3dFcnJvcihuZXcgRXJyb3IoYWNrKSkgOiBvZihhY2spKSksXG4gICAgICByZXRyeVdoZW4oKGVycm9ycykgPT4gZXJyb3JzLnBpcGUoZGVsYXkoMTAwMCksIHRha2UoMTApKSlcbiAgICApO1xuICAgIGNvbnN0IGxvZ2luT3JBdXRoJCA9IGZyb20oW2F1dGgkLCBsb2dpbiRdKS5waXBlKG1lcmdlQWxsKCksIHRha2UoMSkpO1xuICAgIHJldHVybiBsb2dpbk9yQXV0aCQ7XG4gIH1cblxuICBjcmVhdGUoYWxpYXM6IHN0cmluZywgcGFzczogc3RyaW5nKSB7XG4gICAgY29uc3QgYXV0aCQgPSB0aGlzLnJvb3Qub25FdmVudCgnYXV0aCcpLnBpcGUoXG4gICAgICBmaWx0ZXIoKGFjaykgPT4ge1xuICAgICAgICByZXR1cm4gYWNrLnB1dC5hbGlhcyA9PT0gYWxpYXM7XG4gICAgICB9KSxcbiAgICAgIHRha2UoMSlcbiAgICApO1xuICAgIHRoaXMuZ3VuLmNyZWF0ZShhbGlhcywgcGFzcyk7XG4gICAgcmV0dXJuIGF1dGgkO1xuICB9XG5cbiAgc2VjcmV0KHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodGhpcy5ndW4uc2VjcmV0KSB7XG4gICAgICByZXR1cm4gdGhpcy5mcm9tKHRoaXMuZ3VuLnNlY3JldCh2YWx1ZSkpO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0dVTi5jaGFpbi5zZWNyZXQgTk9UIEZPVU5EJyk7XG4gIH1cblxuICBmcm9tPFQ+KGd1bjogSUd1bkNoYWluUmVmZXJlbmNlPFQ+KSB7XG4gICAgcmV0dXJuIG5ldyBHdW5BdXRoQ2hhaW48VD4odGhpcy5uZ1pvbmUsIGd1biwgdGhpcy5yb290KTtcbiAgfVxuXG4gIHJlY2FsbCgpIHtcbiAgICB0aGlzLmd1bi5yZWNhbGwoeyBzZXNzaW9uU3RvcmFnZTogdHJ1ZSB9KTtcbiAgICByZXR1cm4gdGhpcy5hdXRoJC5waXBlKHRpbWVvdXQoNTAwMCkpO1xuICB9XG5cbiAgbG9nb3V0KCkge1xuICAgIHRoaXMuZ3VuLmxlYXZlKCk7XG4gIH1cbiAgcHV0KFxuICAgIGRhdGE6IFBhcnRpYWw8XG4gICAgICBBbHdheXNEaXNhbGxvd2VkVHlwZTxEaXNhbGxvd1ByaW1pdGl2ZXM8SXNUb3AsIERpc2FsbG93QXJyYXk8RGF0YVR5cGU+Pj5cbiAgICA+LFxuICAgIGNlcnRpZmljYXRlOiBzdHJpbmcgPSB0aGlzLmNlcnRpZmljYXRlXG4gICkge1xuICAgIHJldHVybiBzdXBlci5wdXQoZGF0YSwgY2VydGlmaWNhdGUpO1xuICB9XG59XG5cbi8qKiBSZXByZXNlbnRzIGEgbm9kZSBuZXN0ZWQgdW5kZXIgYSB1c2VyL3BhaXJcbiAqIGd1bi51c2VyKCkgOiBBdXRoQ2hhaW5cbiAqIGd1bi51c2VyKHB1YikgOiBVc2VyQ2hhaW5cbiAqIGd1bi5nZXQoJ35AYWxpYXMnKSA6IEd1bkNoYWluPHtwdWI6IHN0cmluZ30+XG4gKi9cbmV4cG9ydCBjbGFzcyBHdW5DZXJ0Q2hhaW4gZXh0ZW5kcyBHdW5DaGFpbiB7fVxuIl19